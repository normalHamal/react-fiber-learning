<!DOCTYPE html>
<html style="width: 100%; height: 100%; overflow: hidden">
  <head>
    <meta charset="utf-8">
    <title>Fiber reconciliation</title>
  </head>
  <body>
    <div id="container">
    </div>
    <script src="js/react.development.js"></script>
    <script src="js/react-dom.development.js"></script>
    <script src="js/scheduler.development.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.24/browser.min.js"></script>
    <script type="text/babel">
let lastText = '';
class Low extends React.Component {
  componentWillUpdate(nextProps, nextState) {
    console.error('Low componentWillUpdata fired', nextProps);
    if (lastText === this.props.text) {
      console.error('Low componentWillUpdata fired again');
    }
    lastText = this.props.text;

    const start = Date.now();
    while (Date.now() - start < 250);
  }

  shouldComponentUpdate(nextProps) {
    return nextProps.text !== this.props.text;
  }

  render() {
    return (
      <h2>{this.props.text}</h2>
    )
  }
}

class App extends React.Component {
  constructor() {
    super();
    this.state = { text: 'initial' };
  }

  handleClick() {
    // A1 - B2 - C1 - D2
    Scheduler.unstable_runWithPriority(Scheduler.unstable_UserBlockingPriority, () => {
      console.error('Insert Update A1');
      this.setState({
        text: 'A',
      });
    });

    Scheduler.unstable_runWithPriority(Scheduler.unstable_NormalPriority, () => {
      console.error('Insert Update B2');
      this.setState({
        text: 'B',
      });
    });

    Scheduler.unstable_runWithPriority(Scheduler.unstable_UserBlockingPriority, () => {
      console.error('Insert Update C1');
      this.setState({
        text: 'C',
      });
    });

    Scheduler.unstable_runWithPriority(Scheduler.unstable_NormalPriority, () => {
      console.error('Insert Update D2');
      this.setState({
        text: 'D',
      });
    });
  }

  render() {
    const { text } = this.state;

    return (
      <React.Fragment>
        <button onClick={this.handleClick.bind(this)}>开始模拟调度</button>
        <Low text={text} />
      </React.Fragment>
    );
  }
}

ReactDOM.createRoot(
  document.getElementById('container')
).render(<App />);
    </script>
  </body>
</html>
